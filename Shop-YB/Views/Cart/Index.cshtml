@using System.Security.Claims;


@{
    var role = User.FindFirst(ClaimTypes.Role);
    var user = User.FindFirst(ClaimTypes.Name);
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_UserLayout.cshtml";
    int sum = 0;
    int discountSum = 0;
}



<div style="background-color:white">


    @if (ViewBag.Cart == null)
    {
        <h3>سبد شما خالی است</h3>
    }
    else
    {
        <div class="row">
            <div class="col-lg-6">
                <h3 class="pull-right" style="margin:10px 30px;">
                    سبد خرید [ <small>@ViewBag.CountItems محصول </small>]
                </h3>
            </div>

            <div class="col-lg-6" style="margin-top: auto; padding-left: 30px;">
                <a asp-controller="home" class="btn btn-large btn-info"><i class="icon-arrow-left"></i> ادامه خرید </a>

            </div>



        </div>

        <hr class="soft" />

        <table class="table table-bordered table-hover table-striped">
            <thead>
                <tr>
                    <th>محصول</th>
                    <th>توضیحات</th>
                    <th>تعداد</th>
                    <th>قیمت</th>
                    <th>تخفیف</th>
                    <th>جمع</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var cart in (IEnumerable<ShopYB.Models.Item>)ViewBag.Cart)
                {

                    var totalPrice = cart.Price * cart.Quantity;
                    sum += totalPrice;
                    var totalDiscount = cart.BasePrice * cart.Quantity;
                    discountSum += totalDiscount;
                    <tr>
                        <td> <img width="60" src="~/products/@cart.PhotoName" alt="" /></td>
                        <td>@cart.Product.Name<br />Color : , Material : </td>
                        <td>
                            <div class="input-append">
                                <button class="btn btn-primary minus" type="button" style="font-size:8pt"><i class="fa fa-minus"></i></button>
                                <input class="span1 quantity" style="max-width:34px" value="@cart.Quantity" id="appendedInputButtons" data-id="@cart.Product.Id" size="16" type="text">

                                <button class="btn btn-primary plus" type="button" id="plus" style="font-size:8pt"><i class="fa fa-plus"></i></button>
                                <a class="btn btn-danger" asp-controller="cart" asp-action="remove" asp-route-id="@cart.Product.Id"><i class="fa fa-trash"></i></a>
                            </div>
                        </td>
                        <td>@cart.Price.ToString("#,##")<span>ریال</span> </td>
                        <td>@cart.BasePrice.ToString("#,##")<span>ریال</span></td>
                        <td id="totalPrice">@((cart.Price * cart.Quantity).ToString("#,##")) <span>ریال</span> </td>
                    </tr>
                }
                <tr>
                    <td colspan="5" style="text-align:right">جمع کل:	</td>
                    <td> @sum.ToString("#,##") <span>ریال</span> </td>
                </tr>


                <tr>
                    <td colspan="5" style="text-align:right">جمع تخفیف:	</td>
                    <td class="text-danger"> @discountSum.ToString("#,##") <span>ریال</span></td>

                </tr>
                <tr>

                    <td colspan="5" style="text-align:right"><strong>جمع</strong></td>
                    <td class="label label-important" style="display:block"> <strong> @sum.ToString("#,##") <span>ریال</span> </strong></td>
                </tr>



            </tbody>
        </table>

        <div class="row">
            <div class="col-lg-12" style="float:right;text-align: justify;padding: 10px 40px;">
                <form class="form">
                    <div class="control-group">
                        <label class="control-label"><strong> کد تخفیف: </strong> </label>
                        <div class="controls">
                            <input type="text" class="input-medium" placeholder="کد">
                            <button type="submit" class="btn btn-success"> اعمال کردن </button>
                        </div>
                    </div>
                </form>
            </div>


        </div>

        <hr />
        <div class="row">
            <div class="col-lg-12" style="padding:10px 50px">
                <a asp-controller="home" class="btn btn-large btn-info"><i class="icon-arrow-left"></i> ادامه خرید </a>
                <a asp-controller="cart" asp-action="shipping" class="btn btn-large btn-info pull-right">نهایی کردن خرید <i class="icon-arrow-right"></i></a>
            </div>

        </div>

    }
</div>


<script src="~/user/themes/js/jquery.js"></script>
<script>
    //$("#plus").click(function () {
    //    var quantity = $("#appendedInputButtons").val();
    //    quantity= parseInt(quantity)+1;
    //    alert(quantity);
    //    $("#appendedInputButtons").val(quantity);
    //});

    $(".plus").click(function () {

        var target = $('.quantity', this.parentNode)[0];
        target.value = +target.value + 1;
        var productId = $('.quantity', this.parentNode)[0];
        var pid = $(productId).attr("data-id");
        console.log(pid);

        $.ajax({
            url: "@Url.Action("buyJson", "cart")",
            type: "POST",
            data: {
                id: pid,
                quantity: target.value
            },
            success: function (response) {
                if (response == true) {
                    location.reload();
                }
            }

        });
    });


    $(".minus").click(function () {
        var target = $('.quantity', this.parentNode)[0];
        target.value = +target.value - 1;
        var productId = $('.quantity', this.parentNode)[0];
        var pid = $(productId).attr("data-id");
        console.log(pid);

        $.ajax({
            url: "@Url.Action("buyJson", "cart")",
            type: "POST",
            data: {
                id: pid,
                quantity: target.value
            },
            success: function (response) {
                if (response == true) {
                    location.reload();
                }
            }

        });
    });

</script>
